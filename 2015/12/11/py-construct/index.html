<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用Python-Construct解析数据和生成协议 | XzAmrzs&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;#160; &amp;#160; &amp;#160; &amp;#160;直接切入正题，我们知道在Python中解析数据包有一个内置的Struct库，但是那个库解析起来实在是笨拙，只关心数据的内容，而construct的解析会像字典那样把内容分门别类的展示出来，首先看一下connstruct的作用(这段摘自官方文档)
construct的作用
&amp;#160; &amp;#160; &amp;#160; &amp;#160; Construct">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Python-Construct解析数据和生成协议">
<meta property="og:url" content="http://yoursite.com/2015/12/11/py-construct/index.html">
<meta property="og:site_name" content="XzAmrzs's Blog">
<meta property="og:description" content="&amp;#160; &amp;#160; &amp;#160; &amp;#160;直接切入正题，我们知道在Python中解析数据包有一个内置的Struct库，但是那个库解析起来实在是笨拙，只关心数据的内容，而construct的解析会像字典那样把内容分门别类的展示出来，首先看一下connstruct的作用(这段摘自官方文档)
construct的作用
&amp;#160; &amp;#160; &amp;#160; &amp;#160; Construct">
<meta property="og:image" content="http://7xox9y.com1.z0.glb.clouddn.com/RFIDprotocol.jpg">
<meta property="og:updated_time" content="2015-12-11T09:38:56.294Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Python-Construct解析数据和生成协议">
<meta name="twitter:description" content="&amp;#160; &amp;#160; &amp;#160; &amp;#160;直接切入正题，我们知道在Python中解析数据包有一个内置的Struct库，但是那个库解析起来实在是笨拙，只关心数据的内容，而construct的解析会像字典那样把内容分门别类的展示出来，首先看一下connstruct的作用(这段摘自官方文档)
construct的作用
&amp;#160; &amp;#160; &amp;#160; &amp;#160; Construct">
  
    <link rel="alternative" href="/atom.xml" title="XzAmrzs&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="http://7xox9y.com1.z0.glb.clouddn.com/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xox9y.com1.z0.glb.clouddn.com/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">XzAmrzs</a></h1>
		</hgroup>

		
		<p class="header-subtitle">路很长、还要走</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/随笔">随笔</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/XzAmrzs" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/3672449634" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/dong-huang-amrzs" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/construct/" style="font-size: 10px;">construct</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.jianshu.com/users/d557aa88529a/latest_articles">我的简书博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我的名字是&#39;邢志鹏&#39;，目前坐标河南郑州，就读于河南工业大学，大三在读软件狗,主攻python开发:爬虫、建站、大数据</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">XzAmrzs</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xox9y.com1.z0.glb.clouddn.com/avatar.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">XzAmrzs</h1>
			</hgroup>
			
			<p class="header-subtitle">路很长、还要走</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/随笔">随笔</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/XzAmrzs" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/3672449634" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/dong-huang-amrzs" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-py-construct" class="article article-type-post" itemscope
         itemprop="blogPost">
    
    <div class="article-meta">
        <a href="/2015/12/11/py-construct/" class="article-date">
  	<time datetime="2015-12-11T09:38:56.295Z" itemprop="datePublished">2015-12-11</time>
</a>
    </div>
    
    <div class="article-inner">
        
        <input type="hidden" class="isFancy"/>
        
        
        <header class="article-header">
            
  
    <h1 class="article-title" itemprop="name">
      使用Python-Construct解析数据和生成协议
    </h1>
  

        </header>
        
        <div class="article-info article-info-post">
            
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/construct/">construct</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</div>

            

            <div class="clearfix"></div>
        </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            
            <!-- Table of Contents -->
            
            <div id="toc" class="toc-article">
                <strong class="toc-title">文章目录</strong>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#construct的作用"><span class="toc-number">1.</span> <span class="toc-text">construct的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用法实例"><span class="toc-number">2.</span> <span class="toc-text">用法实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用法讲解"><span class="toc-number">3.</span> <span class="toc-text">用法讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fields"><span class="toc-number">3.1.</span> <span class="toc-text">Fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Structs"><span class="toc-number">3.2.</span> <span class="toc-text">Structs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Containers"><span class="toc-number">3.3.</span> <span class="toc-text">Containers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Building"><span class="toc-number">3.4.</span> <span class="toc-text">Building</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#嵌套使用"><span class="toc-number">3.5.</span> <span class="toc-text">嵌套使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Embedding"><span class="toc-number">3.6.</span> <span class="toc-text">Embedding</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sequences"><span class="toc-number">3.7.</span> <span class="toc-text">Sequences</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Repeaters"><span class="toc-number">3.8.</span> <span class="toc-text">Repeaters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Enums"><span class="toc-number">3.9.</span> <span class="toc-text">Enums</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ctx"><span class="toc-number">3.10.</span> <span class="toc-text">ctx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Switch"><span class="toc-number">3.11.</span> <span class="toc-text">Switch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他的用法"><span class="toc-number">3.12.</span> <span class="toc-text">其他的用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战仿写"><span class="toc-number">4.</span> <span class="toc-text">实战仿写</span></a></li></ol>
            </div>
            
            <p>&#160; &#160; &#160; &#160;直接切入正题，我们知道在<code>Python</code>中解析数据包有一个内置的<code>Struct</code>库，但是那个库解析起来实在是笨拙，只关心数据的内容，而construct的解析会像字典那样把内容分门别类的展示出来，首先看一下connstruct的作用(这段摘自官方文档)</p>
<h2 id="construct的作用">construct的作用</h2><blockquote>
<p>&#160; &#160; &#160; &#160; Construct is a powerful declarative parser (and builder) for binary data.</p>
<p>&#160; &#160; &#160; &#160;Instead of writing imperative code to parse a piece of data, you declaratively define a data structure that describes your data. As this data structure is not code, you can use it in one direction to parse data into Pythonic objects, and in the other direction, convert (“build”) objects into binary data.</p>
<p>&#160; &#160; &#160; &#160;The library provides both simple, atomic constructs (such as integers of various sizes), as well as composite ones which allow you form hierarchical structures of increasing complexity. Construct features bit and byte granularity, easy debugging and testing, an easy-to-extend subclass system, and lots of primitive constructs to make your work easier:</p>
</blockquote>
<a id="more"></a>
<blockquote>
<ul>
<li>Fields: raw bytes or numerical types</li>
<li>Structs and Sequences: combine simpler constructs into more complex ones</li>
<li>Adapters: change how data is represented</li>
<li>Arrays/Ranges: duplicate constructs</li>
<li>Meta-constructs: use the context (history) to compute the size of data</li>
<li>If/Switch: branch the computational path based on the context</li>
<li>On-demand (lazy) parsing: read only what you require</li>
<li>Pointers: jump from here to there in the data stream</li>
</ul>
</blockquote>
<h2 id="用法实例">用法实例</h2><p>&#160; &#160; &#160; &#160;首先解析数据肯定要协议，我们首先来看一段解析RFID数据包的协议<br><strong>阅读器工作正常时的响应报文（READER→PC）：</strong><br><img src="http://7xox9y.com1.z0.glb.clouddn.com/RFIDprotocol.jpg" alt="*RFID协议例子*"></p>
<p>对应的Construct的编写方法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Constructor</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="comment"># 接收数据的数据格式定义</span></span><br><span class="line">		self.F1 = Struct(<span class="string">"sub"</span>,</span><br><span class="line">		                 UBInt8(<span class="string">"readerID"</span>),</span><br><span class="line">		                 UBInt8(<span class="string">"packet_len"</span>),</span><br><span class="line">		                 UBInt8(<span class="string">"status"</span>),</span><br><span class="line">		                 Array(<span class="keyword">lambda</span> ctx: (</span><br><span class="line">			                                   ctx.packet_len - <span class="number">2</span> - <span class="number">1</span> - <span class="number">1</span> - <span class="number">1</span> - <span class="number">1</span> - <span class="number">2</span>) / <span class="number">6</span>,</span><br><span class="line">		                       Struct(<span class="string">"blocks"</span>,</span><br><span class="line">		                              Array(<span class="number">3</span>, UBInt8(<span class="string">'cardID'</span>)),</span><br><span class="line">		                              UBInt8(<span class="string">'triggerID'</span>),</span><br><span class="line">		                              UBInt16(<span class="string">'relativeTime'</span>)</span><br><span class="line">		                              )</span><br><span class="line">		                       )</span><br><span class="line">		                 )</span><br><span class="line">        </span><br><span class="line">		self.F2=Struct(<span class="string">"sub"</span>, UBInt8(<span class="string">"packet_len"</span>), UBInt8(<span class="string">"readerID"</span>))</span><br><span class="line">		self.F3=Struct(<span class="string">"sub"</span>, UBInt8(<span class="string">"packet_len"</span>), UBInt8(<span class="string">"result"</span>))</span><br><span class="line">		self.F4=Struct(<span class="string">"sub"</span>, UBInt8(<span class="string">"packet_len"</span>), UBInt8(<span class="string">"rssl"</span>))</span><br><span class="line">        </span><br><span class="line">		self.constructFrame = Struct(<span class="string">"frame"</span>,</span><br><span class="line">                                     OptionalGreedyRange(</span><br><span class="line">                                         Struct(<span class="string">"packets"</span>,</span><br><span class="line">                                                UBInt16(<span class="string">"header"</span>),</span><br><span class="line">                                                Enum(UBInt8(<span class="string">"cmdcode"</span>),</span><br><span class="line">                                                     F1=<span class="number">0xF1</span>,</span><br><span class="line">                                                     F2=<span class="number">0xF2</span>,</span><br><span class="line">                                                     F3=<span class="number">0xF3</span>,</span><br><span class="line">                                                     F4=<span class="number">0xF4</span>,</span><br><span class="line">                                                     ),</span><br><span class="line">                                                Switch(<span class="string">"datas"</span>, <span class="keyword">lambda</span> ctx: ctx.cmdcode, &#123;</span><br><span class="line">                                                    <span class="string">"F1"</span>: Embed(self.F1),</span><br><span class="line">                                                    <span class="string">"F2"</span>: Embed(self.F2),</span><br><span class="line">                                                    <span class="string">"F3"</span>: Embed(self.F3),</span><br><span class="line">                                                    <span class="string">"F4"</span>: Embed(self.F4),</span><br><span class="line"></span><br><span class="line">                                                &#125;</span><br><span class="line">                                                       ),</span><br><span class="line">                                                UBInt16(<span class="string">"crc"</span>),</span><br><span class="line">                                                )</span><br><span class="line">                                     ),</span><br><span class="line">                                     OptionalGreedyRange(</span><br><span class="line">                                         UBInt8(<span class="string">"leftovers"</span>),</span><br><span class="line">                                     ),</span><br><span class="line">                                     )</span><br></pre></td></tr></table></figure>
<p>测试数据:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rfid = Constructor()</span><br><span class="line">data = rfid.parse_pkgs(</span><br><span class="line">    <span class="string">'\xFF\xFF\xF1\x07\x26\x05\x00\x13\x9A\x00\x00\x1D\x80\x13\x8E\x00\x00\x1D\x00\x13\x8C\x00\x00\x1D\x00\x13\x8D\x00\x00\x15\x80\x13\x94\x00\x00\x13\x77\xF9'</span>)</span><br><span class="line"><span class="keyword">print</span> data[<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    Container:</span><br><span class="line">        header = <span class="number">65535</span></span><br><span class="line">        cmdcode = <span class="string">'F1'</span></span><br><span class="line">        readerID = <span class="number">7</span></span><br><span class="line">        packet_len = <span class="number">38</span></span><br><span class="line">        status = <span class="number">5</span></span><br><span class="line">        blocks = [</span><br><span class="line">            Container:</span><br><span class="line">                cardID = [</span><br><span class="line">                    <span class="number">0</span></span><br><span class="line">                    <span class="number">19</span></span><br><span class="line">                    <span class="number">154</span></span><br><span class="line">                ]</span><br><span class="line">                triggerID = <span class="number">0</span></span><br><span class="line">                relativeTime = <span class="number">29</span></span><br><span class="line">            Container:</span><br><span class="line">                cardID = [</span><br><span class="line">                    <span class="number">128</span></span><br><span class="line">                    <span class="number">19</span></span><br><span class="line">                    <span class="number">142</span></span><br><span class="line">                ]</span><br><span class="line">                triggerID = <span class="number">0</span></span><br><span class="line">                relativeTime = <span class="number">29</span></span><br><span class="line">            Container:</span><br><span class="line">                cardID = [</span><br><span class="line">                    <span class="number">0</span></span><br><span class="line">                    <span class="number">19</span></span><br><span class="line">                    <span class="number">140</span></span><br><span class="line">                ]</span><br><span class="line">                triggerID = <span class="number">0</span></span><br><span class="line">                relativeTime = <span class="number">29</span></span><br><span class="line">            Container:</span><br><span class="line">                cardID = [</span><br><span class="line">                    <span class="number">0</span></span><br><span class="line">                    <span class="number">19</span></span><br><span class="line">                    <span class="number">141</span></span><br><span class="line">                ]</span><br><span class="line">                triggerID = <span class="number">0</span></span><br><span class="line">                relativeTime = <span class="number">21</span></span><br><span class="line">            Container:</span><br><span class="line">                cardID = [</span><br><span class="line">                    <span class="number">128</span></span><br><span class="line">                    <span class="number">19</span></span><br><span class="line">                    <span class="number">148</span></span><br><span class="line">                ]</span><br><span class="line">                triggerID = <span class="number">0</span></span><br><span class="line">                relativeTime = <span class="number">19</span></span><br><span class="line">        ]</span><br><span class="line">        crc = <span class="number">30713</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="用法讲解">用法讲解</h2><h3 id="Fields">Fields</h3><p><code>Fields</code>是<code>Construct</code>中最基础的用法，所以的其他用法都是基于<code>Fields</code>构成的，它们负责<strong>parse</strong>(从数据流中读数据)和<strong>build</strong>(生成一个对象并把它写到数据流)。<code>Construct</code>中有许多的<code>Fields</code>，每一个服务于不同的数据类型(数字的，布尔类型的，字符串类型的)<br>例子:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> construct <span class="keyword">import</span> UBInt16, ULInt16</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>UBInt16(<span class="string">"foo"</span>).parse(<span class="string">"\x01\x02"</span>)  <span class="comment"># Unsigned, big endian 8-bit integer</span></span><br><span class="line"><span class="number">258</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ULInt16(<span class="string">"foo"</span>).parse(<span class="string">"\x01\x02"</span>)  <span class="comment"># Unsigned, little endian 8-bit integer</span></span><br><span class="line"><span class="number">513</span></span><br></pre></td></tr></table></figure></p>
<p>其中<code>UBInt8(&quot;foo&quot;)</code>就是一个最基本的<code>Fields</code>,至于<code>endian</code>是什么请大家自行百度,但是常用big endian</p>
<p><strong>其中<code>U</code>可换成<code>S</code>表示符号型，<code>B</code>可换成<code>L</code>表示小端，<code>16</code>表示的是解析的位数:1个字节为8位,2个字节就是16位，<code>foo</code>就是<code>Fields</code>的名字</strong></p>
<p>Some examples of building:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> construct <span class="keyword">import</span> UBInt16, SBInt16</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>UBInt16(<span class="string">"foo"</span>).build(<span class="number">31337</span>)</span><br><span class="line"><span class="string">'zi'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>SBInt16(<span class="string">"foo"</span>).build(-<span class="number">31337</span>)</span><br><span class="line"><span class="string">'\x86\x97'</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Structs">Structs</h3><p>定义一个解析格式，会按照顺序解析，其结构是一个放置在<code>container</code>(一个字典)中的序列集合，<strong>这里有个坑，如果出现字段结构重名，那么将采用最后一个同名的字段作为解析的值,所以名字不要出现重复</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> construct <span class="keyword">import</span> Struct, UBInt8, SLInt16, LFloat32</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    SLInt16(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>    LFloat32(<span class="string">"c"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c</span><br><span class="line">&lt;Struct(<span class="string">'foo'</span>)&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x07\x00\x01\x00\x00\x00\x01"</span>)</span><br><span class="line">Container(a = <span class="number">7</span>, b = <span class="number">256</span>, c = <span class="number">2.350988701644575e-038</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Containers">Containers</h3><p>Containers是一个字典对象，所有Construct解析出来都会是一个Containers对象，所以直接按照<code>python</code>中的<code>dict</code>对象来操作就行。代码接着上面的<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = c.parse(<span class="string">"\x07\x00\x01\x00\x00\x00\x01"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x</span><br><span class="line">Container(a = <span class="number">7</span>, b = <span class="number">256</span>, c = <span class="number">2.350988701644575e-038</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.a</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.b</span><br><span class="line"><span class="number">256</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">print</span> x</span><br><span class="line">Container:</span><br><span class="line">    a = <span class="number">7</span></span><br><span class="line">    b = <span class="number">256</span></span><br><span class="line">    c = <span class="number">2.350988701644575e-038</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Building">Building</h3><p>注意:<code>build()</code>方法的参数是一个任意的类对象，作用是用来构建一个新的<code>Container</code>对象比如下面:<br><strong>这个方法很有用，受第3个例子的启发，在定义了包格式以后，可以用这个方法来生成一个我们想要的数据包，需要就是将特定的参数设置成变量后，传进去即可</strong><br><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="special">#</span> 重新构建一个这样的对象</span><br><span class="line">&gt;&gt;&gt; c.build(x)</span><br><span class="line">'<span class="command">\x</span>07<span class="command">\x</span>00<span class="command">\x</span>01<span class="command">\x</span>00<span class="command">\x</span>00<span class="command">\x</span>00<span class="command">\x</span>01'</span><br></pre></td></tr></table></figure></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># 改变解析对象并且生成一个新的...</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; x.b = <span class="number">5000</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.build(x)</span><br><span class="line"><span class="string">'\x07\x88\x13\x00\x00\x00\x01'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># 或者我们可以这样来构建一个新的Container对象</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.build(<span class="constant">Container</span>(a = <span class="number">9</span>, b = <span class="number">1234</span>, c = <span class="number">56.78</span>))</span><br><span class="line"><span class="string">'\t\xd2\x04\xb8\x1ecB'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class <span class="function"><span class="title">Foo</span><span class="params">(object)</span></span>: pass</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; f = <span class="function"><span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line">&gt;&gt;&gt; f<span class="class">.a</span> = <span class="number">1</span></span><br><span class="line">&gt;&gt;&gt; f<span class="class">.b</span> = <span class="number">2</span></span><br><span class="line">&gt;&gt;&gt; f<span class="class">.c</span> = <span class="number">3</span></span><br><span class="line">&gt;&gt;&gt; c.<span class="function"><span class="title">build</span><span class="params">(f)</span></span></span><br><span class="line"><span class="string">'\x01\x02\x00\x00\x00@@'</span></span><br></pre></td></tr></table></figure>
<h3 id="嵌套使用">嵌套使用</h3><p>一个Struct可以包含其他的Structs。例子<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt16(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>    Struct(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>        UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>        UBInt16(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>    )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = c.parse(<span class="string">"ABBabb"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x</span><br><span class="line">Container(a = <span class="number">65</span>, b = <span class="number">16962</span>, bar = Container(a = <span class="number">97</span>, b = <span class="number">25186</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">print</span> x</span><br><span class="line">Container:</span><br><span class="line">    a = <span class="number">65</span></span><br><span class="line">    b = <span class="number">16962</span></span><br><span class="line">    bar = Container:</span><br><span class="line">        a = <span class="number">97</span></span><br><span class="line">        b = <span class="number">25186</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.a</span><br><span class="line"><span class="number">65</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.bar</span><br><span class="line">Container(a = <span class="number">97</span>, b = <span class="number">25186</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.bar.b</span><br><span class="line"><span class="number">25186</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Embedding">Embedding</h3><p>一个Struct可以被嵌入到另一个Struct中使用，这意味着所有的Fieleds都将融合成一个封闭的Struct，<strong>这里要注意不是字符串形式的名字就是嵌套了，需要用<code>Embed()</code>函数，否则是两个Container!!</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar = Struct(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>    foo, <span class="comment"># 这个Struct是没有被嵌入的，和上面那个例子的作用相同</span></span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"c"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"d"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar2= Struct(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>    Embed(foo), <span class="comment"># 这个Struct是被嵌入的</span></span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"c"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"d"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar.parse(<span class="string">"abcd"</span>)</span><br><span class="line">Container(c = <span class="number">99</span>, d = <span class="number">100</span>, foo = Container(a = <span class="number">97</span>, b = <span class="number">98</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar2.parse(<span class="string">"abcd"</span>)</span><br><span class="line">Container(a = <span class="number">97</span>, b = <span class="number">98</span>, c = <span class="number">99</span>, d = <span class="number">100</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="Sequences">Sequences</h3><p><code>Sequence</code>和<code>Strcut</code>的结构很类似，但是它操作的是列表而不是字典，<code>Sequence</code>相比<code>Struct</code>用的比较少，但是在某些特定的情况下用的比较多，当只需要得到一个<code>Container</code>的数据而不关心名字的时候，就会比较有用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Sequence(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt16(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c</span><br><span class="line">&lt;Sequence(<span class="string">'foo'</span>)&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"abb"</span>)</span><br><span class="line">[<span class="number">97</span>, <span class="number">25186</span>]</span><br></pre></td></tr></table></figure>
<p>Building<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"><span class="string">'\x01\x00\x02'</span></span><br></pre></td></tr></table></figure></p>
<p>Nested<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Sequence(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt16(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>    Sequence(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>        UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>        UBInt16(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>    )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"ABBabb"</span>)</span><br><span class="line">[<span class="number">65</span>, <span class="number">16962</span>, [<span class="number">97</span>, <span class="number">25186</span>]]</span><br></pre></td></tr></table></figure></p>
<p>Embedded<br>用法同<code>Struct</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Sequence(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"b"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar = Sequence(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>    foo,                  <span class="comment"># &lt;-- unembedded</span></span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"c"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"d"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar2 = Sequence(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>    Embed(foo),           <span class="comment"># &lt;-- embedded</span></span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"c"</span>),</span><br><span class="line"><span class="prompt">... </span>    UBInt8(<span class="string">"d"</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar.parse(<span class="string">"abcd"</span>)</span><br><span class="line">[[<span class="number">97</span>, <span class="number">98</span>], <span class="number">99</span>, <span class="number">100</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>bar2.parse(<span class="string">"abcd"</span>)</span><br><span class="line">[<span class="number">97</span>, <span class="number">98</span>, <span class="number">99</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="Repeaters">Repeaters</h3><p>重复器！，这个东西在接受一组相同类型数据的时候很有用，就比如上图中的一次接受了三个卡号，每个卡号都是一个字节的情况.这一部分只是静态重复器，动态的重复器介绍将另外说明</p>
<ol>
<li><code>construct.Range(mincount, maxcout, subcon)</code><br>Example:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Range(<span class="number">3</span>, <span class="number">7</span>, UBInt8(<span class="string">"foo"</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02"</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">construct.core.RangeError: expected <span class="number">3.</span><span class="number">.7</span>, found <span class="number">2</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03\x04\x05\x06"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03\x04\x05\x06\x07"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03\x04\x05\x06\x07\x08\x09"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">construct.core.RangeError: expected <span class="number">3.</span><span class="number">.7</span>, found <span class="number">2</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])</span><br><span class="line"><span class="string">'\x01\x02\x03\x04'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">construct.core.RangeError: expected <span class="number">3.</span><span class="number">.7</span>, found <span class="number">8</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p><code>construct.Array(count, subcon)</code><br>Example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Array(<span class="number">4</span>, UBInt8(<span class="string">"foo"</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03\x04"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03\x04\x05\x06"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>])</span><br><span class="line"><span class="string">'\x05\x06\x07\x08'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">construct.core.RangeError: expected <span class="number">4.</span><span class="number">.4</span>, found <span class="number">5</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>construct.GreedyRange(subcon)</code><br> 匹配一次或者多次，类似正则表达式中的<code>+</code></p>
<p> Example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> construct <span class="keyword">import</span> GreedyRange, UBInt8</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = GreedyRange(UBInt8(<span class="string">"foo"</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01"</span>)</span><br><span class="line">[<span class="number">1</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02\x03\x04\x05\x06"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">""</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">construct.core.RangeError: expected <span class="number">1.</span><span class="number">.2147483647</span>, found <span class="number">0</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"><span class="string">'\x01\x02'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([])</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">construct.core.RangeError: expected <span class="number">1.</span><span class="number">.2147483647</span>, found <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>construct.OptionalGreedyRange(subcon)</code><br> 重复给定的解析单元0或者更多次，即表示这个方法出现的时候<strong>无论通讯有没有连接</strong>（注意这一点）！解析都不会失败。类似正则中的<code>*</code>，(所以在实际运用中可以用它来接收”冗余”数据或者”粘包”的情况)<br> Example:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> construct <span class="keyword">import</span> OptionalGreedyRange, UBInt8</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = OptionalGreedyRange(UBInt8(<span class="string">"foo"</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">""</span>)</span><br><span class="line">[]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x01\x02"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([])</span><br><span class="line"><span class="string">''</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.build([<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line"><span class="string">'\x01\x02'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>Nesting<br>嵌套的重复器<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Array(<span class="number">5</span>, Array(<span class="number">2</span>, UBInt8(<span class="string">"foo"</span>)))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"aabbccddee"</span>)</span><br><span class="line">[[<span class="number">97</span>, <span class="number">97</span>], [<span class="number">98</span>, <span class="number">98</span>], [<span class="number">99</span>, <span class="number">99</span>], [<span class="number">100</span>, <span class="number">100</span>], [<span class="number">101</span>, <span class="number">101</span>]]</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Enums">Enums</h3><p>这个函数提供一种解析映射，就像它的名字那样，解析出来的数值必须是提前就默认的，如果不是就会报错！<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Enum(Byte(<span class="string">"protocol"</span>),</span><br><span class="line"><span class="prompt">... </span>    TCP = <span class="number">6</span>,</span><br><span class="line"><span class="prompt">... </span>    UDP = <span class="number">17</span>,</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c</span><br><span class="line">&lt;MappingAdapter(<span class="string">'protocol'</span>)&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># parsing</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.parse(<span class="string">"\x06"</span>)</span><br><span class="line"><span class="string">'TCP'</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.parse(<span class="string">"\x11"</span>)</span><br><span class="line"><span class="string">'UDP'</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.parse(<span class="string">"\x12"</span>)</span><br><span class="line"><span class="constant">Traceback</span> (most recent call last)<span class="symbol">:</span></span><br><span class="line">  .</span><br><span class="line">  .</span><br><span class="line">construct.adapters.<span class="constant">MappingAdapterError</span><span class="symbol">:</span> undefined mapping <span class="keyword">for</span> <span class="number">18</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;</span>&gt; <span class="comment"># building</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.build(<span class="string">"TCP"</span>)</span><br><span class="line"><span class="string">'\x06'</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt; c.build(<span class="string">"UDP"</span>)</span><br><span class="line"><span class="string">'\x11'</span></span><br><span class="line"><span class="prompt">&gt;&gt;</span>&gt;</span><br></pre></td></tr></table></figure>
<p><strong>如果你不想让程序报异常，我们也可以提供一个不存在的映射，可以使用<code>_default_</code>关键字，如果不是默认值，就让它取一个你自定义的值。</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Enum(Byte(<span class="string">"protocol"</span>),</span><br><span class="line"><span class="prompt">... </span>    TCP = <span class="number">6</span>,</span><br><span class="line"><span class="prompt">... </span>    UDP = <span class="number">17</span>,</span><br><span class="line"><span class="prompt">... </span>    _default_ = <span class="string">"blah"</span></span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x11"</span>)</span><br><span class="line"><span class="string">'UDP'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x12"</span>) <span class="comment"># no mapping for 18, so default to "blah"</span></span><br><span class="line"><span class="string">'blah'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果我们只是想部分取值，部分仍然正常解析，就可以使<code>_default_</code>参数等于<code>pass</code>.这个可以放在某些要特定的包格式中来使用<br>(比如7E格式的固定包头就可以使用这种方法来解析，下面例子给出的是对单个字节的，于是我们现在是不是就可以写一个大的<code>Struct</code>通过这种方式放置多个<code>Struct</code>来达到一个大协议解析许多个小协议的目的?不过不推荐这种做法，因为耦合太严重了。)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = Enum(Byte(<span class="string">"protocol"</span>),</span><br><span class="line"><span class="prompt">... </span>    TCP = <span class="number">6</span>,</span><br><span class="line"><span class="prompt">... </span>    UDP = <span class="number">17</span>,</span><br><span class="line"><span class="prompt">... </span>    _default_ = Pass</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x11"</span>)</span><br><span class="line"><span class="string">'UDP'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\x12"</span>) <span class="comment"># no mapping, passing through</span></span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.parse(<span class="string">"\xff"</span>) <span class="comment"># no mapping, passing through</span></span><br><span class="line"><span class="number">255</span></span><br></pre></td></tr></table></figure></p>
<h3 id="ctx">ctx</h3><p>所有的的动态<code>construct</code>都有一个通常被用作<code>lamada</code>表达式参数的函数，除非特别说明，这个lamada函数的唯一参数就是<code>ctx</code>(short for context),并且就像<code>lamada</code>用法一样，可以返回一个计算过的结果.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"length"</span>),</span><br><span class="line"><span class="prompt">... </span>    Field(<span class="string">"data"</span>, <span class="keyword">lambda</span> ctx: ctx.length * <span class="number">2</span> + <span class="number">1</span>),  <span class="comment"># &lt;-- calculate</span></span><br><span class="line">the length of the string</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x05abcdefghijkXXX"</span>)</span><br><span class="line">Container(data = <span class="string">'abcdefghijk'</span>, length = <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>因为作为匿名函数，所以可以返回任何值<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"length"</span>),</span><br><span class="line"><span class="prompt">... </span>    Field(<span class="string">"data"</span>, <span class="keyword">lambda</span> ctx: <span class="number">7</span>),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x99abcdefg"</span>)</span><br><span class="line">Container(data = <span class="string">'abcdefg'</span>, length = <span class="number">153</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>注意:另外可以使用<code>&#39;_&#39;</code>去获取外层的struct映射</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"length1"</span>),</span><br><span class="line"><span class="prompt">... </span>    Struct(<span class="string">"bar"</span>,</span><br><span class="line"><span class="prompt">... </span>        Byte(<span class="string">"length2"</span>),</span><br><span class="line"><span class="prompt">... </span>        Field(<span class="string">"data"</span>, <span class="keyword">lambda</span> ctx: ctx._.length1 + ctx.length2),</span><br><span class="line"><span class="prompt">... </span>    )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x02\x03abcde"</span>)</span><br><span class="line">Container(bar = Container(data = <span class="string">'abcde'</span>, length2 = <span class="number">3</span>), length1 = <span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="Switch">Switch</h3><p>很重要！这个大家应该很容易看出来作用，可以根据前面解析出来的指令，动态的选择接下来要解析的路径<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Enum(Byte(<span class="string">"type"</span>),</span><br><span class="line"><span class="prompt">... </span>        INT1 = <span class="number">1</span>,</span><br><span class="line"><span class="prompt">... </span>        INT2 = <span class="number">2</span>,</span><br><span class="line"><span class="prompt">... </span>        INT4 = <span class="number">3</span>,</span><br><span class="line"><span class="prompt">... </span>        STRING = <span class="number">4</span>,</span><br><span class="line"><span class="prompt">... </span>    ),</span><br><span class="line"><span class="prompt">... </span>    Switch(<span class="string">"data"</span>, <span class="keyword">lambda</span> ctx: ctx.type,</span><br><span class="line"><span class="prompt">... </span>        &#123;</span><br><span class="line">    ...             <span class="string">"INT1"</span> : UBInt8(<span class="string">"spam"</span>),</span><br><span class="line">    ...             <span class="string">"INT2"</span> : UBInt16(<span class="string">"spam"</span>),</span><br><span class="line">    ...             <span class="string">"INT4"</span> : UBInt32(<span class="string">"spam"</span>),</span><br><span class="line">    ...             <span class="string">"STRING"</span> : String(<span class="string">"spam"</span>, <span class="number">6</span>),</span><br><span class="line">    ...         &#125;</span><br><span class="line">    ...     )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x01\x12"</span>)</span><br><span class="line">Container(data = <span class="number">18</span>, type = <span class="string">'INT1'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x02\x12\x34"</span>)</span><br><span class="line">Container(data = <span class="number">4660</span>, type = <span class="string">'INT2'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x03\x12\x34\x56\x78"</span>)</span><br><span class="line">Container(data = <span class="number">305419896</span>, type = <span class="string">'INT4'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x04abcdef"</span>)</span><br><span class="line">Container(data = <span class="string">'abcdef'</span>, type = <span class="string">'STRING'</span>)</span><br></pre></td></tr></table></figure></p>
<p>可以设置一个default属性，当switch中的协议无法解析的时候选择该路径进行解析,否则<code>construct</code>会抛出异常<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"type"</span>),</span><br><span class="line"><span class="prompt">... </span>    Switch(<span class="string">"data"</span>, <span class="keyword">lambda</span> ctx: ctx.type,</span><br><span class="line"><span class="prompt">... </span>        &#123;</span><br><span class="line">    ...             <span class="number">1</span> : UBInt8(<span class="string">"spam"</span>),</span><br><span class="line">    ...             <span class="number">2</span> : UBInt16(<span class="string">"spam"</span>),</span><br><span class="line">    ...         &#125;,</span><br><span class="line">    ...         default = UBInt8(<span class="string">"spam"</span>)            <span class="comment"># &lt;-- sets the default</span></span><br><span class="line">    construct</span><br><span class="line">    ...     )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x01\xff"</span>)</span><br><span class="line">Container(data = <span class="number">255</span>, type = <span class="number">1</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x02\xff\xff"</span>)</span><br><span class="line">Container(data = <span class="number">65535</span>, type = <span class="number">2</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x03\xff\xff"</span>)                   <span class="comment"># &lt;-- uses the default</span></span><br><span class="line">construct</span><br><span class="line">Container(data = <span class="number">255</span>, type = <span class="number">3</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>类似<code>Enum</code>，可以使用<code>pass</code>参数来强制忽略掉异常<strong>（所有的“强制忽略”都不推荐,个人认为应该抛出异常并且让服务器记录错误并且给出错误提示。）</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"type"</span>),</span><br><span class="line"><span class="prompt">... </span>    Switch(<span class="string">"data"</span>, <span class="keyword">lambda</span> ctx: ctx.type,</span><br><span class="line"><span class="prompt">... </span>        &#123;</span><br><span class="line">    ...             <span class="number">1</span> : UBInt8(<span class="string">"spam"</span>),</span><br><span class="line">    ...             <span class="number">2</span> : UBInt16(<span class="string">"spam"</span>),</span><br><span class="line">    ...         &#125;,</span><br><span class="line">    ...         default = Pass</span><br><span class="line">    ...     )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x01\xff"</span>)</span><br><span class="line">Container(data = <span class="number">255</span>, type = <span class="number">1</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x02\xff\xff"</span>)</span><br><span class="line">Container(data = <span class="number">65535</span>, type = <span class="number">2</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x03\xff\xff"</span>)</span><br><span class="line">Container(data = <span class="keyword">None</span>, type = <span class="number">3</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="其他的用法">其他的用法</h3><p><code>Pointer</code>:指定下标解析，适合包结构比较奇葩，包长度在后面的类型</p>
<p><code>If</code>：类似编程语言<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Flag(<span class="string">"has_options"</span>),</span><br><span class="line"><span class="prompt">... </span>    If(<span class="keyword">lambda</span> ctx: ctx[<span class="string">"has_options"</span>],</span><br><span class="line"><span class="prompt">... </span>        Bytes(<span class="string">"options"</span>, <span class="number">5</span>)</span><br><span class="line"><span class="prompt">... </span>    )</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x01hello"</span>)</span><br><span class="line">Container(has_options = <span class="keyword">True</span>, options = <span class="string">'hello'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x00hello"</span>)</span><br><span class="line">Container(has_options = <span class="keyword">False</span>, options = <span class="keyword">None</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p><code>IfThenElse</code>:类似编程语言<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    IfThenElse(<span class="string">"b"</span>, <span class="keyword">lambda</span> ctx: ctx[<span class="string">"a"</span>] &gt; <span class="number">7</span>,</span><br><span class="line"><span class="prompt">... </span>        UBInt32(<span class="string">"foo"</span>),</span><br><span class="line"><span class="prompt">... </span>        UBInt16(<span class="string">"bar"</span>)</span><br><span class="line"><span class="prompt">... </span>    ),</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x09\xaa\xbb\xcc\xdd"</span>)    <span class="comment"># &lt;-- condition is met</span></span><br><span class="line">Container(a = <span class="number">9</span>, b = <span class="number">2864434397L</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x02\xaa\xbb"</span>)            <span class="comment"># &lt;-- condition is not met</span></span><br><span class="line">Container(a = <span class="number">2</span>, b = <span class="number">43707</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong><code>Value</code>（这个用法在<code>build</code>的时候会很有用）</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo = Struct(<span class="string">"foo"</span>,</span><br><span class="line"><span class="prompt">... </span>    Byte(<span class="string">"a"</span>),</span><br><span class="line"><span class="prompt">... </span>    Value(<span class="string">"b"</span>, <span class="keyword">lambda</span> ctx: ctx[<span class="string">"a"</span>] + <span class="number">7</span>)</span><br><span class="line"><span class="prompt">... </span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>foo.parse(<span class="string">"\x02"</span>)</span><br><span class="line">Container(a = <span class="number">2</span>, b = <span class="number">9</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="实战仿写">实战仿写</h2><p>现在我们根据<code>Xbee</code>通信的数据包格式来仿照着写出一个解析<code>Xbee</code>的<code>Constructor</code><br>首先我们需要知道<code>xbee</code>的<code>7E格式</code>通讯协议<br><strong>Xbee-&gt;PC:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">位置</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">名称</th>
<th style="text-align:center">长度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">包头</td>
<td style="text-align:center">header</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">包长度</td>
<td style="text-align:center">plen</td>
<td style="text-align:center">16bit</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">传输方向</td>
<td style="text-align:center">dir</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">节点ID</td>
<td style="text-align:center">plen</td>
<td style="text-align:center">64bit</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">功能号</td>
<td style="text-align:center">funcid</td>
<td style="text-align:center">16bit</td>
</tr>
<tr>
<td style="text-align:center">6~N-2</td>
<td style="text-align:center">数据块数组</td>
<td style="text-align:center">data</td>
<td style="text-align:center">64bit*N</td>
</tr>
<tr>
<td style="text-align:center">N-1</td>
<td style="text-align:center">包校验</td>
<td style="text-align:center">crc</td>
<td style="text-align:center">8bit</td>
</tr>
</tbody>
</table>
<p>根据这个我们再来写出一个xbee的解析（不唯一）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XbeeConstructor</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="comment"># 接收数据的数据格式定义</span></span><br><span class="line">		self.constructFrame = Struct(<span class="string">"parser"</span>,</span><br><span class="line">				OptionalGreedyRange(</span><br><span class="line">					Struct(<span class="string">"packets"</span>,</span><br><span class="line">						UBInt8(<span class="string">"header"</span>),</span><br><span class="line">						UBInt16(<span class="string">"plen"</span>),</span><br><span class="line">						UBInt8(<span class="string">"dir"</span>),</span><br><span class="line">						UBInt64(<span class="string">"nodeid"</span>),</span><br><span class="line">						UBInt16(<span class="string">"funcid"</span>),</span><br><span class="line">						Array(<span class="keyword">lambda</span> ctx: (ctx.plen - <span class="number">1</span> - <span class="number">8</span> - <span class="number">2</span>) / <span class="number">8</span>,</span><br><span class="line">							Struct(<span class="string">"block"</span>,</span><br><span class="line">								Array(<span class="number">2</span>, UBInt8(<span class="string">"type"</span>)),</span><br><span class="line">								Array(<span class="number">2</span>, UBInt8(<span class="string">"unit"</span>)),</span><br><span class="line">								Array(<span class="number">4</span>, UBInt8(<span class="string">"value"</span>)),</span><br><span class="line">							      )</span><br><span class="line">						     ),</span><br><span class="line">						UBInt8(<span class="string">"crc"</span>),</span><br><span class="line">					      ),</span><br><span class="line">					),</span><br><span class="line">				OptionalGreedyRange(</span><br><span class="line">					UBInt8(<span class="string">"leftovers"</span>),</span><br><span class="line">					),</span><br><span class="line">				)</span><br></pre></td></tr></table></figure></p>
<p>再来看一组要生成的报文，我们这次通过build方法来生成需要发送的指令（实际上都是要写出数据的<code>struct</code>的），这个调用build()方法来生成一个我们想要的数据<br><strong>PC-&gt;Xbee:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">位置</th>
<th style="text-align:center">名称</th>
<th style="text-align:center">长度</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">header</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">length</td>
<td style="text-align:center">16bit</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">type</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">id</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">64address</td>
<td style="text-align:center">64bit</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">16address</td>
<td style="text-align:center">16bit</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">broadcast</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">options</td>
<td style="text-align:center">8bit</td>
</tr>
<tr>
<td style="text-align:center">8~N-2</td>
<td style="text-align:center">data</td>
<td style="text-align:center">8bit*N</td>
</tr>
<tr>
<td style="text-align:center">N-1</td>
<td style="text-align:center">checksum</td>
<td style="text-align:center">8bit</td>
</tr>
</tbody>
</table>
<p><strong>这之中最难的其实不是结构该如何写，而是怎么让它在执行build方法的时候把校验值也动态生成出来</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XbeePacketBuilder</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="comment"># 接收数据的数据格式定义</span></span><br><span class="line">		self.constructFrame = Struct(<span class="string">"parser"</span>,</span><br><span class="line">				OptionalGreedyRange(</span><br><span class="line">					Struct(<span class="string">"packets"</span>,</span><br><span class="line">						UBInt8(<span class="string">"header"</span>),</span><br><span class="line">						UBInt16(<span class="string">"length"</span>),</span><br><span class="line">						UBInt8(<span class="string">"frameType"</span>),</span><br><span class="line">						UBInt8(<span class="string">"id"</span>),</span><br><span class="line">						UBInt64(<span class="string">"64address"</span>),</span><br><span class="line">						UBInt16(<span class="string">"16address"</span>),</span><br><span class="line">						UBInt8(<span class="string">"broadcast"</span>),</span><br><span class="line">						UBInt8(<span class="string">"options"</span>),</span><br><span class="line">						Array(<span class="keyword">lambda</span> ctx: (ctx.length- <span class="number">1</span> - <span class="number">8</span> - <span class="number">2</span>) / <span class="number">8</span>,</span><br><span class="line">							Embed(Struct(<span class="string">"block"</span>,</span><br><span class="line">									Array(<span class="number">2</span>, UBInt8(<span class="string">"type"</span>)),</span><br><span class="line">									Array(<span class="number">2</span>, UBInt8(<span class="string">"unit"</span>)),</span><br><span class="line">									Array(<span class="number">4</span>, UBInt8(<span class="string">"value"</span>)),</span><br><span class="line">								    ))</span><br><span class="line">						     ),</span><br><span class="line">						UBInt8(<span class="string">"checksum"</span>),</span><br><span class="line">					      ),</span><br><span class="line">					),</span><br><span class="line">				OptionalGreedyRange(</span><br><span class="line">						UBInt8(<span class="string">"leftovers"</span>),</span><br><span class="line">						),</span><br><span class="line">				)</span><br></pre></td></tr></table></figure></p>

            
        </div>
        
    </div>
    
    
<nav id="article-nav">
  
  
    <a href="/2015/12/11/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">看到这篇Blog的人，你们好</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

    
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>


<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="py-construct" data-title="使用Python-Construct解析数据和生成协议" data-url="http://yoursite.com/2015/12/11/py-construct/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"xzamrzs"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 XzAmrzs
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>